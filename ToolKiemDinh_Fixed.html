<!DOCTYPE html>
<html>
<head>
    <title>GPT OCR Kiá»ƒm Äá»‹nh Thiáº¿t Bá»‹</title>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>
<body>
    <h2>ğŸ“ Upload PDF kiá»ƒm Ä‘á»‹nh:</h2>
    <input type="file" id="pdfFile" accept=".pdf"><br><br>

    <label>ğŸ”‘ Nháº­p API Key khÃ¡c (náº¿u muá»‘n override):</label><br>
    <input type="password" id="apiKey" size="80"><br><br>

    <input type="hidden" id="webhook" value="https://script.google.com/macros/s/AKfycbw7I3-J3KBi5dX2p8oeqAequm0h_TpDaQLyNzBGjMn/exec">

    <button onclick="processPDF()">ğŸ“¤ Xá»­ lÃ½ & TrÃ­ch xuáº¥t JSON</button><br><br>
    <textarea id="output" rows="20" cols="100" placeholder="JSON káº¿t quáº£ sáº½ hiá»ƒn thá»‹ táº¡i Ä‘Ã¢y..."></textarea><br><br>
    <button onclick="sendJSON()">ğŸš€ Gá»­i lÃªn Báº£ng tÃ­nh Cloud</button>

    <script>
    const defaultKey = "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";

    async function processPDF() {
        const fileInput = document.getElementById("pdfFile");
        const apiKeyInput = document.getElementById("apiKey");
        const output = document.getElementById("output");
        const key = apiKeyInput.value.trim() || defaultKey;

        if (!fileInput.files.length) {
            alert("Vui lÃ²ng chá»n file PDF.");
            return;
        }

        const file = fileInput.files[0];
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(" ");
                fullText += pageText + "\n";
            }

            const prompt = `DÆ°á»›i Ä‘Ã¢y lÃ  ná»™i dung cá»§a vÄƒn báº£n kiá»ƒm Ä‘á»‹nh thiáº¿t bá»‹. HÃ£y Ä‘á»c tháº­t ká»¹ vÃ  chá»‰ trÃ­ch xuáº¥t JSON náº¿u tháº¥y Ä‘á»§ thÃ´ng tin trong ná»™i dung. Náº¿u khÃ´ng tháº¥y má»™t trÆ°á»ng nÃ o thÃ¬ Ä‘á»ƒ trá»‘ng hoáº·c ghi lÃ  KhÃ´ng Ä‘á»c Ä‘Æ°á»£c thÃ´ng tin. CÃ³ thá»ƒ suy Ä‘oÃ¡n á»Ÿ má»©c tÆ°Æ¡ng Ä‘á»‘i thÃ´ng tin Ä‘á»c Ä‘Æ°á»£c trong tÃ i liá»‡u. NhaCungCap chá»‰ láº¥y náº¿u dÃ²ng chá»©a Ã­t nháº¥t 2 trong sá»‘: â€œCÃ´ng tyâ€, â€œKiá»ƒm Ä‘á»‹nhâ€, â€œCháº¥t lÆ°á»£ngâ€, â€œdá»‹ch vá»¥â€, â€œtÆ° váº¥nâ€ , TNHH, TM ... Æ¯u tiÃªn dÃ²ng in hoa rÃµ rÃ ng á»Ÿ Ä‘áº§u vÄƒn báº£n. KhÃ´ng chá»n dÃ²ng ngáº«u nhiÃªn. Náº¿u khÃ´ng cháº¯c cháº¯n, Ä‘á»ƒ null . Tiáº¿p tá»¥c chÃº Ã½ pháº§n TÃªn thiáº¿t bá»‹ thÃ¬ nÃ³ thÆ°á»ng tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i TÃªn Äá»‘i tÆ°á»£ng hoáº·c Äá»‘i tÆ°á»£ng Ä‘Æ°á»£c kiá»ƒm Ä‘á»‹nh trong vÄƒn báº£n, náº¿u nghi ngá» nÃ³ lÃ  Tiáº¿ng Viá»‡t cÃ³ dáº¥u thÃ¬ tá»± thÃªm dáº¥u vÃ o Ä‘á»ƒ thÃ nh tá»« cÃ³ nghÄ©a. \n\n${fullText}\n\nTrÃ­ch xuáº¥t dÆ°á»›i Ä‘á»‹nh dáº¡ng JSON gá»“m cÃ¡c trÆ°á»ng: TenThietBi, MaSerial, NgayBatDau, ThoiHanThang, NgayHetHan, NhaCungCap.`;

            const payload = {
                model: "gpt-4o",
                messages: [
                    { role: "system", content: "Báº¡n lÃ  má»™t trá»£ lÃ½ OCR thÃ´ng minh, chá»‰ trÃ­ch xuáº¥t dá»¯ liá»‡u thá»±c táº¿ tá»« tÃ i liá»‡u PDF kiá»ƒm Ä‘á»‹nh." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.2
            };

            try {
                const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + key
                    },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                if (result.choices && result.choices[0].message) {
                    output.value = result.choices[0].message.content;
                } else {
                    output.value = "âŒ Lá»—i tá»« GPT:\n" + JSON.stringify(result, null, 2);
                }
            } catch (e) {
                output.value = "âŒ Lá»—i khi gá»i API:\n" + e;
            }
        };
        fileReader.readAsArrayBuffer(file);
    }

    async function sendJSON() {
        const webhook = document.getElementById("webhook").value.trim();
        const data = document.getElementById("output").value;

        if (!webhook || !data) {
            alert("Thiáº¿u Webhook hoáº·c dá»¯ liá»‡u JSON.");
            return;
        }

        try {
            const res = await fetch(webhook, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: data
            });

            if (res.ok) {
                alert("âœ… Gá»­i JSON thÃ nh cÃ´ng!");
            } else {
                alert("âŒ Gá»­i tháº¥t báº¡i. MÃ£ lá»—i: " + res.status);
            }
        } catch (e) {
            alert("âŒ Lá»—i khi gá»­i: " + e);
        }
    }
    </script>
</body>
</html>
